<!DOCTYPE html>
<html>
  <head>
    <title>RAA LTF</title>

    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />

    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <style>
      body {
        background-color: antiquewhite;
      }

      gux-tab-panel > div {
        width: 1500px;
        padding: 20px;
      }

      gux-tab-panel > div > div {
        margin-bottom: 20px;
      }

      fieldset {
        background-color: white;
        width: 80%;
        margin: 0 auto;
      }

      #forecasts-table td {
        text-align: left;
      }
      #forecasts-table th,
      #forecasts-table td {
        text-align: left;
      }

      .buttons-div {
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <fieldset>
      <h1>RAA Long Term Forecast</h1>

      <gux-tabs orientation="vertical" style="display: block">
        <gux-tab-list id="tab-list" slot="tab-list" active-tab="2">
          <gux-tab id="inputs-tab" tab-id="1">Inputs</gux-tab>
          <gux-tab id="outputs-tab" tab-id="2">Outputs</gux-tab>
        </gux-tab-list>
        <gux-tab-panel id="inputs-tab-panel" tab-id="1" style="overflow: auto">
          <div class="dropdown-div">
            <label for="business-unit"><h2>Business Unit:</h2></label>
            <gux-dropdown
              id="business-unit"
              filter-type="starts-with"
              placeholder="Select a Business Unit"
            >
              <gux-listbox
                id="business-unit-listbox"
                aria-label="Business Unit Selection"
              >
                <!-- BU objects will be added dynamically -->
              </gux-listbox>
            </gux-dropdown>
          </div>

          <div class="table-div">
            <label for="forecast"><h2>Forecast:</h2></label>

            <gux-table-beta id="forecasts-table" object-table>
              <table slot="data">
                <thead>
                  <tr>
                    <th data-column-name="radio" data-cell-action>Select</th>
                    <th data-column-name="week-date">Week Date</th>
                    <th data-column-name="week-count">Week Count</th>
                    <th data-column-name="week-description">Description</th>
                  </tr>
                </thead>
                <tbody id="forecasts-table-body">
                  <!-- Forecast objects will be added dynamically -->
                </tbody>
              </table>
            </gux-table-beta>
          </div>

          <div class="buttons-div">
            <gux-button id="generate-button" accent="primary"
              >Generate</gux-button
            >
          </div>
        </gux-tab-panel>
        <gux-tab-panel id="outputs-tab-panel" tab-id="2" style="overflow: auto">
          <div class="dropdown-div">
            <label for="planning-group"><h2>Planning Group:</h2></label>
            <gux-dropdown
              id="planning-group"
              filter-type="starts-with"
              placeholder="Select a Planning Group"
            >
              <gux-listbox
                id="business-unit-listbox"
                aria-label="Planning Group Selection"
              >
                <!-- PG objects will be added dynamically -->
              </gux-listbox>
            </gux-dropdown>
          </div>
          <div class="table-div">
            <label for="forecast"><h2>Outputs:</h2></label>

            <gux-table-beta id="outputs-table" object-table>
              <table slot="data">
                <thead>
                  <tr>
                    <!-- Month of the forecast -->
                    <th data-column-name="cal-month" id="monthColumn">Month</th>

                    <!-- Forecasted number of calls offered -->
                    <th data-column-name="offered" id="forecastOfferedColumn">
                      Forecast Offered
                    </th>

                    <!-- Forecasted Average Handling Time -->
                    <th data-column-name="aht" id="forecastAhtColumn">
                      Forecast AHT
                    </th>

                    <!-- Service Level percentage -->
                    <th data-column-name="sl-threshold" id="slPercentColumn">
                      SL %
                    </th>

                    <!-- Service Level time -->
                    <th data-column-name="sl-time" id="slTimeColumn">
                      SL time
                    </th>

                    <!-- Average Speed of Answer -->
                    <th data-column-name="asa" id="asaColumn">ASA</th>

                    <!-- Occupancy percentage -->
                    <th data-column-name="occupancy" id="occupancyColumn">
                      OCC %
                    </th>

                    <!-- Base Full-Time Equivalent -->
                    <th data-column-name="base-fte" id="baseFteColumn">
                      Base FTE
                    </th>

                    <!-- Mean Square Error of Forecast -->
                    <th data-column-name="mseff" id="mseffColumn">MSEFF</th>

                    <!-- Shrinkage percentage -->
                    <th data-column-name="shrinkage" id="shrinkageColumn">
                      Shrinkage
                    </th>

                    <!-- Required Full-Time Equivalent -->
                    <th data-column-name="req-fte" id="reqFteColumn">
                      Req FTE
                    </th>

                    <!-- Actual Full-Time Equivalent -->
                    <th data-column-name="act-fte" id="actFteColumn">
                      Act FTE
                    </th>

                    <!-- Attrition percentage -->
                    <th data-column-name="attr-per" id="attritionPercentColumn">
                      Attrition %
                    </th>

                    <!-- Absolute Attrition -->
                    <th data-column-name="attr-per" id="absAttritionColumn">
                      ABS Attrition
                    </th>

                    <!-- New Hire Full-Time Equivalent -->
                    <th data-column-name="new-fte" id="newHireFteColumn">
                      New Hire FTE
                    </th>

                    <!-- Variance in Required Full-Time Equivalent -->
                    <th data-column-name="variance" id="fteReqPlusMinusColumn">
                      FTE Req +/-
                    </th>
                  </tr>
                </thead>
                <tbody id="outputs-table-body">
                  <!-- Forecast objects will be added dynamically -->
                </tbody>
              </table>
            </gux-table-beta>
          </div>
          <div class="buttons-div">
            <gux-button id="back-button" accent="secondary">Back</gux-button>
            <gux-button id="export-button" accent="primary">Export</gux-button>
          </div>
        </gux-tab-panel>
      </gux-tabs>
    </fieldset>

    <!-- Load the PureCloud platform client library -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <script>
      // wait for dom to load
      document.addEventListener("DOMContentLoaded", async function () {
        // Check testing mode by protocol. If https then production, else testing
        const isTesting = window.location.protocol !== "https:";

        if (isTesting) {
          console.log("[LTF] Testing mode");
        } else {
          console.log("[LTF] Production mode");

          var platformClient = window.require("platformClient");

          var clientId = "4c89c35c-d1ec-4fad-91f5-240d37b4d546";

          window.client = platformClient.ApiClient.instance;
          client.setEnvironment("usw2.pure.cloud");
          client.setPersistSettings(true, "ltf-widget");

          try {
            await client.loginImplicitGrant(
              clientId,
              "https://apmaries.github.io/raa-ltf/widget.html"
            );
          } catch (e) {
            console.error("[LTF] Error logging in", e);
          }
        }
      });
    </script>
    <script>
      // Check testing mode by protocol. If https then production, else testing
      const isTesting = window.location.protocol !== "https:";

      window.onerror = function (message, source, lineno, colno, error) {
        console.error(
          `[LTF] An error occurred: ${message}\nAt: ${source}:${lineno}:${colno}`
        );
        console.error(error);
        return true; // Prevents the firing of the default event handler.
      };

      document.addEventListener("DOMContentLoaded", async function () {
        var platformClient = window.require("platformClient");
        const client = window.client;
        const wfmApi = new platformClient.WorkforceManagementApi();

        const buListbox = document.getElementById("business-unit-listbox");
        //const forecastListbox = document.getElementById("forecast-listbox");
        const tableBody = document.getElementById("forecasts-table-body");

        // Functions start here

        // Function to get Business Units
        async function getBusinessUnits() {
          try {
            let data;
            if (isTesting) {
              const response = await fetch(".test/businessUnits.json");
              data = await response.json();
            } else {
              data = await wfmApi.getWorkforcemanagementBusinessunits();
            }
            console.log("[LTF] Business Units = ", data);
            return data.entities || [];
          } catch (err) {
            console.error("[LTF] Error getting business units", err);
            return [];
          }
        }

        // Function to get Forecasts
        async function getForecasts(selectedBuId) {
          try {
            let data;
            if (isTesting) {
              const response = await fetch(".test/forecasts.json");
              data = await response.json();
            } else {
              data =
                await wfmApi.getWorkforcemanagementBusinessunitWeekShorttermforecasts(
                  selectedBuId,
                  "recent"
                );
            }
            console.log("[LTF] Forecasts = ", data);

            // filter results to only include forecasts with weekCount > 6
            data.entities = data.entities.filter((item) => item.weekCount > 6);

            return data.entities || [];
          } catch (err) {
            console.error("[LTF] Error getting forecasts", err);
            return [];
          }
        }

        // Function to initialize the widget
        async function init() {
          // Get business unit entities
          const businessUnits = await getBusinessUnits();

          // If no business units found, display message in dropdown
          if (businessUnits.length === 0) {
            console.log("[LTF] No business units found");
            const option = document.createElement("gux-option");
            option.innerHTML = "No business units found";
            buListbox.appendChild(option);
            return;
          }

          // sort data by name (not case sensitive)
          businessUnits.sort((a, b) =>
            a.name.localeCompare(b.name, undefined, { sensitivity: "base" })
          );

          // Populate business unit dropdown
          const fragment = document.createDocumentFragment();
          businessUnits.forEach((item) => {
            const option = document.createElement("gux-option");
            option.value = item.id;
            option.name = item.name;
            option.innerHTML = item.name;
            fragment.appendChild(option);
          });
          buListbox.appendChild(fragment);
        }

        // Function to generate forecast output
        async function generate() {
          // Get forecast table selected object by forecast-radio name
          const selectedForecastRadio = document.querySelector(
            "input[name='forecast-radio']:checked"
          );

          console.log("[LTF] Generating forecast data");
          console.log("[LTF] Selected business unit: ", selectedBuId);
          console.log("[LTF] Selected forecast: ", selectedForecastId);

          // Remove gux-disabled attribute from Outputs tab
          // TODO: This is not working... not sure why
          /*var tabPanel = document.querySelector('gux-tab-panel[tab-id="2"]');
          if (tabPanel) {
            console.log(
              "[LTF] Removing gux-disabled attribute from Outputs tab"
            );
            tabPanel.removeAttribute("gux-disabled");
          }*/

          // Switch to tab 2
          document.querySelector("#outputs-tab").click();

          async function getForecastData() {
            // Get forecast data
          }

          // Temp function to load forecastData.json
          async function loadForecastData() {
            // Load forecast data
            const response = await fetch("/raa-ltf/.test/forecastData.json");
            console.log("[LTF] Test data loaded");
            return response.json();
          }
        }

        // Functions end here

        // init on page load
        await init();

        // Event listeners
        // Event listener for bu-listbox
        let selectedBuId;
        let selectedBuName;
        buListbox.addEventListener("change", async (event) => {
          selectedBuId = event.target.value;

          // Get the selected gux-option's innerHTML
          var selectedOption = Array.from(
            buListbox.querySelectorAll("gux-option")
          ).find((option) => option.value === selectedBuId);
          selectedBuName = selectedOption ? selectedOption.innerHTML : "";

          // Remove <!----> if found in selectedBuName
          selectedBuName = selectedBuName.replace(/<!---->/g, "");

          console.log(
            `[LTF] Selected business unit: ${selectedBuId} (${selectedBuName})`
          );

          // Remove existing forecast options
          tableBody.innerHTML = "";

          // Get long term forecast objects to populate dropdown
          // Forecast entities are filtered to only include forecasts with weekCount > 6
          const forecasts = await getForecasts(selectedBuId);

          // If no forecasts found, add table row with message
          if (forecasts.length === 0) {
            console.log("[LTF] No forecasts found");
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4">No forecasts found</td>`;
            tableBody.appendChild(row);
            return;
          }

          // sort data by weekDate (not case sensitive)
          forecasts.sort((a, b) =>
            a.weekDate.localeCompare(b.weekDate, undefined, {
              sensitivity: "base",
            })
          );

          // Populate forecasts table

          const fragment = document.createDocumentFragment();
          forecasts.forEach((item) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td><input type="radio" name="forecast-radio" value="${item.id}"></td>
                <td>${item.weekDate}</td>
                <td>${item.weekCount}</td>
                <td>${item.description}</td>
              `;
            fragment.appendChild(row);
          });
          tableBody.appendChild(fragment);

          // Event listener for the forecast-radios
          const forecastRadios = document.querySelectorAll(
            "input[name='forecast-radio']"
          );
          forecastRadios.forEach((radio) => {
            radio.addEventListener("change", (event) => {
              selectedForecastId = event.target.value;
              console.log(
                `[LTF] Selected forecast: ${selectedForecastId} (${selectedBuName})`
              );
            });
          });

          // Event listener for generate button
          document
            .getElementById("generate-button")
            .addEventListener("click", () => {
              // If no forecast is selected, display message
              if (!selectedBuId || !selectedForecastId) {
                console.log("[LTF] No forecast selected");
                alert("Please select a forecast");
                return;
              }

              generate(selectedBuId, selectedForecastId);
            });

          // Event listener for back button
          document
            .getElementById("back-button")
            .addEventListener("click", () => {
              // Switch to tab 1
              console.log("[LTF] Switching to tab 1");
              document.querySelector("#inputs-tab").click();
            });
        });
      });
    </script>
    <script type="module" src="/raa-ltf/src/erlangXL97.js"></script>
  </body>
</html>
