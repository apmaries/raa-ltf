<!DOCTYPE html>
<html>
  <head>
    <title>Widget</title>

    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />

    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <style>
      .dropdown {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <fieldset>
      <h1>RAA Long Term Forecast</h1>

      <div class="dropdown">
        <label for="businessUnit">Business Unit:</label>
        <gux-dropdown
          id="businessUnit"
          filter-type="starts-with"
          placeholder="Select a Business Unit"
        >
          <gux-listbox
            id="business-unit-listbox"
            aria-label="Business Unit Selection"
          >
            <!-- BU objects will be added dynamically -->
          </gux-listbox>
        </gux-dropdown>
      </div>

      <div class="dropdown">
        <label for="forecast">Forecast:</label>
        <gux-dropdown
          id="forecast"
          filter-type="starts-with"
          placeholder="Select a long term forecast"
        >
          <gux-listbox id="forecast-listbox" aria-label="Forecast Selection">
            <gux-option value="a">Ant</gux-option>
            <gux-option value="b">Bat</gux-option>
            <gux-option value="c">Cat</gux-option>
          </gux-listbox>
        </gux-dropdown>
      </div>

      <gux-button id="generateBtn" accent="primary">Generate</gux-button>
    </fieldset>

    <!-- Load the PureCloud platform client library -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <script>
      // wait for dom to load
      document.addEventListener("DOMContentLoaded", async function () {
        var platformClient = window.require("platformClient");

        var clientId = "4c89c35c-d1ec-4fad-91f5-240d37b4d546";

        window.client = platformClient.ApiClient.instance;
        client.setEnvironment("usw2.pure.cloud");
        client.setPersistSettings(true, "ltf-widget");

        try {
          await client.loginImplicitGrant(
            clientId,
            "https://apmaries.github.io/raa-ltf/widget.html"
          );
        } catch (e) {
          console.error("[LTF] Error logging in", e);
        }
      });
    </script>
    <script>
      window.onerror = function (message, source, lineno, colno, error) {
        console.error(
          `[LTF] An error occurred: ${message}\nAt: ${source}:${lineno}:${colno}`
        );
        console.error(error);
        return true; // Prevents the firing of the default event handler.
      };

      document.addEventListener("DOMContentLoaded", async function () {
        var platformClient = window.require("platformClient");
        const client = window.client;
        const wfmApi = new platformClient.WorkforceManagementApi();

        const buListbox = document.getElementById("business-unit-listbox");
        const forecastListbox = document.getElementById("forecast-listbox");

        // Functions start here

        // Function to get business units
        async function getBusinessUnits() {
          try {
            const data = await wfmApi.getWorkforcemanagementBusinessunits();
            console.log("[LTF] Business Units = ", data);
            return data.entities || [];
          } catch (err) {
            console.error("[LTF] Error getting business units", err);
            return [];
          }
        }

        // Function to get forecasts
        async function getForecasts(selectedBuId) {
          try {
            const data =
              await wfmApi.getWorkforcemanagementBusinessunitWeekShorttermforecasts(
                selectedBuId,
                "recent"
              );
            console.log("[LTF] Forecasts = ", data);

            // filter results to only include forecasts with weekCount > 6
            data.entities = data.entities.filter((item) => item.weekCount > 6);

            return data.entities || [];
          } catch (err) {
            console.error("[LTF] Error getting forecasts", err);
            return [];
          }
        }

        // Function to initialize the widget
        async function init() {
          // Get business unit entities
          const businessUnits = await getBusinessUnits();

          // If no business units found, display message in dropdown
          if (businessUnits.length === 0) {
            console.log("[LTF] No business units found");
            const option = document.createElement("gux-option");
            option.innerHTML = "No business units found";
            buListbox.appendChild(option);
            return;
          }

          // sort data by name (not case sensitive)
          businessUnits.sort((a, b) =>
            a.name.localeCompare(b.name, undefined, { sensitivity: "base" })
          );

          // Populate business unit dropdown
          const fragment = document.createDocumentFragment();
          businessUnits.forEach((item) => {
            const option = document.createElement("gux-option");
            option.value = item.id;
            option.name = item.name;
            option.innerHTML = item.name;
            fragment.appendChild(option);
          });
          buListbox.appendChild(fragment);
        }

        // Function to generate forecast output
        async function generate() {
          // Function to get forecast data for selected forecast
          console.log("[LTF] Generating forecast data");
          console.log("[LTF] Selected business unit: ", selectedBuId);
          console.log("[LTF] Selected forecast: ", selectedForecastId);

          async function getForecastData() {
            // Get forecast data
          }

          // Temp function to load forecastData.json
          async function loadForecastData() {
            // Load forecast data
            const response = await fetch("/raa-ltf/.test/forecastData.json");
            console.log("[LTF] Test data loaded");
            return response.json();
          }
        }

        // Functions end here

        // init on page load
        await init();

        // Event listeners
        // Event listener for bu-listbox
        let selectedBuId;
        let selectedBuName;
        buListbox.addEventListener("change", async (event) => {
          selectedBuId = event.target.value;

          // Get the selected gux-option's innerHTML
          var selectedOption = Array.from(
            buListbox.querySelectorAll("gux-option")
          ).find((option) => option.value === selectedBuId);
          selectedBuName = selectedOption ? selectedOption.innerHTML : "";

          // Remove <!----> if found in selectedBuName
          selectedBuName = selectedBuName.replace(/<!---->/g, "");

          console.log(
            `[LTF] Selected business unit: ${selectedBuId} (${selectedBuName})`
          );

          // Get long term forecast objects to populate dropdown
          // Forecast entities are filtered to only include forecasts with weekCount > 6
          const forecasts = await getForecasts(selectedBuId);

          // If no forecasts found, display message in dropdown
          if (forecasts.length === 0) {
            console.log("[LTF] No recent forecasts >6 weeks long found");
            const option = document.createElement("gux-option");
            option.innerHTML = "No forecasts found";
            forecastListbox.appendChild(option);
            return;
          }

          // sort data by weekDate (not case sensitive)
          forecasts.sort((a, b) =>
            a.weekDate.localeCompare(b.weekDate, undefined, {
              sensitivity: "base",
            })
          );

          // Populate forecasts dropdown
          const fragment = document.createDocumentFragment();
          forecasts.forEach((item) => {
            const option = document.createElement("gux-option");
            option.value = item.id;
            option.description = item.description;
            option.innerHTML = `${item.weekDate} (${item.description})`;
            fragment.appendChild(option);
          });
          forecastListbox.appendChild(fragment);
        });

        // Event listener for the forecast dropdown
        let selectedForecastId;
        forecastListbox.addEventListener("change", (event) => {
          selectedForecastId = event.target.value;

          // Get the selected gux-option's innerHTML
          var selectedOption = Array.from(
            forecastListbox.querySelectorAll("gux-option")
          ).find((option) => option.value === selectedForecastId);
          var selectedForecastName = selectedOption
            ? selectedOption.innerHTML
            : "";

          // Remove <!----> if found in selectedForecastName
          selectedForecastName = selectedForecastName.replace(/<!---->/g, "");

          console.log(`[LTF] Selected forecast: ${selectedForecastId}`);
        });

        // Event listener for generate button
        document
          .getElementById("generateBtn")
          .addEventListener("click", () =>
            generate(selectedBuId, selectedForecastId)
          );
      });
    </script>
    <script type="module" src="/raa-ltf/src/erlangXL97.js"></script>
  </body>
</html>
