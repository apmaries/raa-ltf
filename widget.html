<!DOCTYPE html>
<html>
  <head>
    <title>Widget</title>

    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />

    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <style>
      .dropdown {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <fieldset>
      <h1>RAA Long Term Forecast</h1>

      <div class="dropdown">
        <label for="businessUnit">Business Unit:</label>
        <gux-dropdown
          id="businessUnit"
          filter-type="starts-with"
          placeholder="Select a Business Unit"
        >
          <gux-listbox
            id="business-unit-listbox"
            aria-label="Business Unit Selection"
          >
            <gux-option value="a">Ant</gux-option>
            <gux-option value="b">Bat</gux-option>
            <gux-option value="c">Cat</gux-option>
          </gux-listbox>
        </gux-dropdown>
      </div>

      <div class="dropdown">
        <label for="forecast">Forecast:</label>
        <gux-dropdown
          id="forecast"
          filter-type="starts-with"
          placeholder="Select a long term forecast"
        >
          <gux-listbox id="forecast-listbox" aria-label="Forecast Selection">
            <gux-option value="a">Ant</gux-option>
            <gux-option value="b">Bat</gux-option>
            <gux-option value="c">Cat</gux-option>
          </gux-listbox>
        </gux-dropdown>
      </div>

      <gux-button id="generateBtn" accent="primary">Generate</gux-button>
    </fieldset>

    <!-- Load the PureCloud platform client library -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <script>
      // wait for dom to load
      document.addEventListener("DOMContentLoaded", async function () {
        var platformClient = window.require("platformClient");

        var clientId = "4c89c35c-d1ec-4fad-91f5-240d37b4d546";

        window.client = platformClient.ApiClient.instance;
        client.setEnvironment("usw2.pure.cloud");
        client.setPersistSettings(true, "ltf-widget");

        try {
          await client.loginImplicitGrant(
            clientId,
            "https://apmaries.github.io/raa-ltf/widget.html"
          );
        } catch (e) {
          console.error("[LTF] Error logging in", e);
        }
      });
    </script>
    <script>
      window.onerror = function (message, source, lineno, colno, error) {
        console.error(
          `[LTF] An error occurred: ${message}\nAt: ${source}:${lineno}:${colno}`
        );
        console.error(error);
        return true; // Prevents the firing of the default event handler.
      };

      document.addEventListener("DOMContentLoaded", async function () {
        var platformClient = window.require("platformClient");
        const client = window.client;
        const wfmApi = new platformClient.WorkforceManagementApi();

        const buListbox = document.getElementById("business-unit-listbox");
        const forecastListbox = document.getElementById("forecast-listbox");

        // Event listener for generate button
        document
          .getElementById("generateBtn")
          .addEventListener("click", generate);

        // Event listener for bu-listbox
        let selectedBuId;
        let selectedBuName;
        buListbox.addEventListener("change", (event) => {
          selectedBuId = event.target.value;

          // Get the selected gux-option's innerHTML
          var selectedOption = Array.from(
            buListbox.querySelectorAll("gux-option")
          ).find((option) => option.value === selectedBuId);
          selectedBuName = selectedOption ? selectedOption.innerHTML : "";

          // Remove <!----> if found in selectedBuName
          selectedBuName = selectedBuName.replace(/<!---->/g, "");

          console.log(
            `[LTF] Selected business unit: ${selectedBuName} (${selectedBuId})`
          );
        });

        // Function to initialize the widget
        async function init() {
          // Get business units to populate dropdown
          async function getBusinessUnits() {
            return wfmApi
              .getWorkforcemanagementBusinessunits()
              .then((data) => {
                console.log("[LTF] Business Units = ", data);
                return data.entities || [];
              })
              .catch((err) => {
                console.error("[LTF] Error getting business units", err);
              });
          }

          // Get business unit entities
          const businessUnits = await getBusinessUnits();

          // If no business units found, display message in dropdown
          if (businessUnits.length === 0) {
            console.log("[LTF] No business units found");
            const option = document.createElement("gux-option");
            option.innerHTML = "No business units found";
            dropdown.appendChild(option);
            return;
          }

          // sort data by name (not case sensitive)
          businessUnits.sort((a, b) =>
            a.name.localeCompare(b.name, undefined, { sensitivity: "base" })
          );

          // Populate business unit dropdown
          businessUnits.array.forEach((item) => {
            const option = document.createElement("gux-option");
            option.value = item.id;
            option.name = item.name;
            option.innerHTML = item.name;
            dropdown.appendChild(option);
          });
        }

        // Get long term forecast objects to populate dropdown
        async function getForecasts(selectedBuId) {}

        async function generate() {
          // Function to get forecast data for selected forecast
          async function getForecastData() {
            // Get forecast data
          }

          // Temp function to load forecastData.json
          async function loadForecastData() {
            // Load forecast data
            const response = await fetch("/raa-ltf/.test/forecastData.json");
            console.log("[LTF] Test data loaded");
            return response.json();
          }
        }

        // main
        await init();
      });
    </script>
    <script type="module" src="/raa-ltf/src/erlangXL97.js"></script>
  </body>
</html>
